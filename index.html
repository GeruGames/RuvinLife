<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mascota Virtual - Prototipo v0</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .game {
      background: white;
      width: 340px;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    h1 { margin: 0 0 8px 0; }

    .topline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #222;
    }

    .topline .muted {
      font-weight: normal;
      color: #666;
      font-size: 12px;
    }

    .stat {
      margin: 10px 0;
      text-align: left;
    }

    .bar {
      background: #ddd;
      border-radius: 8px;
      overflow: hidden;
      height: 16px;
    }

    .fill {
      height: 100%;
      width: 50%;
      background: #4caf50;
      transition: width 150ms linear;
    }

    .status-text {
      margin: 10px 0;
      font-weight: bold;
    }

    .buttons button {
      margin: 5px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #2196f3;
      color: white;
      cursor: pointer;
    }

    .buttons button:hover {
      background: #1976d2;
    }

    #debug {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      line-height: 1.35;
      white-space: pre-wrap;
      text-align: left;
    }

    #testResults {
      font-size: 12px;
      color: #444;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      text-align: left;
      white-space: pre-wrap;
    }

    .pill {
      display: inline-block;
      background: #f1f1f1;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="game">
    <h1>üê∂ Mascota Virtual</h1>

    <div class="topline">
      <div id="diaHora">D√≠a 0 ¬∑ 00:00</div>
      <div class="muted" id="apetitoPill">Apetito: ‚Äî</div>
    </div>

    <div class="stat">Hambre
      <div class="bar"><div class="fill" id="hambre"></div></div>
    </div>

    <div class="stat">Saciedad
      <div class="bar"><div class="fill" id="saciedad"></div></div>
    </div>

    <div class="stat">Energ√≠a
      <div class="bar"><div class="fill" id="energia"></div></div>
    </div>

    <div class="stat">Felicidad
      <div class="bar"><div class="fill" id="felicidad"></div></div>
    </div>

    <div class="status-text" id="estadoDia">D√≠a: ‚Äî</div>
    <div class="status-text" id="estadoFisico">Estado f√≠sico: ‚Äî</div>
    <div class="status-text" id="estadoActividad">Estado: ‚Äî</div>

    <div id="debug"></div>

    <div class="buttons">
      <button id="btnAlimentar">üçñ Alimentar</button>
      <button id="btnJugar">üéæ Jugar</button>
    </div>

    <div id="testResults"></div>
  </div>

  <script>
    // =========================
    // Estado del juego
    // =========================

    // Nota: Hambre = 0 (sin hambre) ... 100 (mucha hambre)
    let hambre = 35;

    // Saciedad REAL (0..150). La barra visible muestra 0..100.
    // Regla: si saciedadReal supera 115 (no visible), el hambre empieza a BAJAR.
    let saciedadReal = 65;

    let energia = 50;
    let felicidad = 50;

    // Estado f√≠sico ‚Äúreal‚Äù (no debe saltar bruscamente): 0..100
    let fisicoScore = 50;

    // Control de tiempo
    let createdAt;      // timestamp creaci√≥n (define D√≠a 0)
    let lastUpdate;     // √∫ltimo tick aplicado
    let lastFedAt;      // √∫ltima comida
    let lastActionAt;   // √∫ltima acci√≥n del usuario

    // Estado de actividad
    let estadoActividad = 'Descansando'; // Descansando | Jugando | Comiendo

    // Rasgo fijo (aleatorio al crear mascota): 0..100
    // M√°s alto = se le pasa la saciedad m√°s r√°pido y le sube el hambre m√°s r√°pido.
    let apetitoAnsiedad = 50;

    // Estado del d√≠a (cambia por D√çA REAL, no por recarga)
    let estadoDia = {
      nombre: 'Tranquilo',
      hambreMod: 1.0,
      saciedadMod: 1.0,
      energiaMod: 1.0,
      felicidadMod: 1.0
    };

    // Para recalcular ‚Äúd√≠a‚Äù solo cuando cambia
    let lastDayIndex = 0;

    // =========================
    // Utilidades
    // =========================

    function clamp(x, min, max) {
      return Math.max(min, Math.min(max, x));
    }

    function clamp01(x) {
      return clamp(x, 0, 1);
    }

    function saciedadVisible() {
      return clamp(saciedadReal, 0, 100);
    }

    function etiquetaApetito(valor) {
      if (valor >= 70) return 'Alto';
      if (valor >= 40) return 'Medio';
      return 'Bajo';
    }

    function formatHora24(date) {
      return date.toLocaleTimeString('es-CL', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    function dayIndexNow(nowTs) {
      // D√≠a 0 desde createdAt
      const ms = nowTs - createdAt;
      return Math.max(0, Math.floor(ms / (24 * 60 * 60 * 1000)));
    }

    function seededRandom01(seed) {
      // PRNG simple (determinista) para que el d√≠a sea estable
      // xorshift32
      let x = seed | 0;
      x ^= x << 13;
      x ^= x >>> 17;
      x ^= x << 5;
      // normaliza a 0..1
      return ((x >>> 0) / 4294967296);
    }

    function pickEstadoDia(dayIdx) {
      const dias = [
        { nombre: 'Tranquilo', hambreMod: 0.95, saciedadMod: 0.95, energiaMod: 1.0, felicidadMod: 1.0 },
        { nombre: 'Ansioso', hambreMod: 1.20, saciedadMod: 1.15, energiaMod: 1.0, felicidadMod: 1.05 },
        { nombre: 'Fr√≠o', hambreMod: 1.10, saciedadMod: 1.05, energiaMod: 0.95, felicidadMod: 1.0 },
        { nombre: 'Juguet√≥n', hambreMod: 1.05, saciedadMod: 1.0, energiaMod: 1.05, felicidadMod: 0.98 },
        { nombre: 'Lento', hambreMod: 0.98, saciedadMod: 0.98, energiaMod: 0.92, felicidadMod: 0.98 }
      ];

      const seed = (createdAt / 1000 | 0) + dayIdx * 1013;
      const r = seededRandom01(seed);
      const idx = Math.floor(r * dias.length);
      return dias[clamp(idx, 0, dias.length - 1)];
    }

    function esHambriento(nowTs) {
      // Regla: Hambriento si super√≥ 6 horas sin comer
      const horasSinComer = (nowTs - lastFedAt) / (1000 * 60 * 60);
      return horasSinComer >= 6;
    }

    function asegurarEstadoDia(nowTs) {
      const d = dayIndexNow(nowTs);
      if (d !== lastDayIndex) {
        lastDayIndex = d;
        estadoDia = pickEstadoDia(d);
      }
    }

    // =========================
    // UI
    // =========================

    function actualizarEstadoFisico() {
      let estadoTexto = 'Estado Ideal';
      if (fisicoScore < 20) estadoTexto = 'Muy Delgado';
      else if (fisicoScore < 40) estadoTexto = 'Delgado';
      else if (fisicoScore < 60) estadoTexto = 'Estado Ideal';
      else if (fisicoScore < 80) estadoTexto = 'Gordito';
      else estadoTexto = 'Sobrepeso';

      document.getElementById('estadoFisico').innerText = 'Estado f√≠sico: ' + estadoTexto;
    }

    function actualizarBarras() {
      const now = Date.now();
      asegurarEstadoDia(now);

      // D√≠a + Hora visible (24h)
      const d = dayIndexNow(now);
      const hora = formatHora24(new Date(now));
      document.getElementById('diaHora').innerText = `D√≠a ${d} ¬∑ ${hora}`;

      // Pill apetito
      document.getElementById('apetitoPill').innerText = `Apetito: ${etiquetaApetito(apetitoAnsiedad)}`;

      // Estado actividad + tag hambriento
      const tagHambriento = esHambriento(now) ? ' ¬∑ Hambriento' : '';
      document.getElementById('estadoActividad').innerText = 'Estado: ' + estadoActividad + tagHambriento;

      document.getElementById('hambre').style.width = hambre + '%';
      document.getElementById('saciedad').style.width = saciedadVisible() + '%';
      document.getElementById('energia').style.width = energia + '%';
      document.getElementById('felicidad').style.width = felicidad + '%';

      document.getElementById('estadoDia').innerText = 'Clima del d√≠a: ' + estadoDia.nombre;

      document.getElementById('debug').innerText =
        `Hambre ${Math.round(hambre)} | Saciedad ${Math.round(saciedadVisible())} (real ${Math.round(saciedadReal)}) | Energ√≠a ${Math.round(energia)} | ` +
        `Felicidad ${Math.round(felicidad)} | F√≠sico ${Math.round(fisicoScore)}\n` +
        `Horas sin comer: ${((now - lastFedAt) / (1000*60*60)).toFixed(2)} | ` +
        `Min sin acci√≥n: ${((now - lastActionAt) / (1000*60)).toFixed(1)} | ` +
        `√öltimo tick: ${Math.round((now - lastUpdate)/1000)}s`;

      actualizarEstadoFisico();
    }

    // =========================
    // Acciones (instant√°neas)
    // =========================

    function alimentar() {
      const now = Date.now();
      lastActionAt = now;
      estadoActividad = 'Comiendo';

      // Alimentar sube saciedad REAL
      saciedadReal = clamp(saciedadReal + 25, 0, 150);

      // Si saciedadReal supera 115 (no visible), baja el hambre algunos puntos (modo lento)
      if (saciedadReal > 115) {
        const exceso = saciedadReal - 115;
        const baja = 0.3 + exceso * 0.01;
        hambre = clamp(hambre - baja, 0, 100);
      }

      // Comer ‚Äúcansa un poquito‚Äù
      energia = clamp(energia - 3, 0, 100);

      lastFedAt = now;
      actualizarBarras();

      setTimeout(() => {
        estadoActividad = 'Descansando';
        actualizarBarras();
      }, 1500);

      guardar();
    }

    function jugar() {
      const now = Date.now();
      lastActionAt = now;
      estadoActividad = 'Jugando';

      // Efectos instant√°neos (la acci√≥n dura poco en UI)
      felicidad = clamp(felicidad + 12, 0, 100);
      energia = clamp(energia - 10, 0, 100);
      saciedadReal = clamp(saciedadReal - 8, 0, 150);

      actualizarBarras();

      setTimeout(() => {
        estadoActividad = 'Descansando';
        actualizarBarras();
      }, 3000);

      guardar();
    }

    // =========================
    // Simulaci√≥n REALISTA (opci√≥n A)
    // =========================

    function tick() {
      const now = Date.now();
      asegurarEstadoDia(now);

      const deltaMs = now - lastUpdate;
      lastUpdate = now;

      // Permitimos saltos grandes (si el usuario vuelve horas despu√©s), pero evitamos extremos absurdos
      const deltaMsCapped = clamp(deltaMs, 0, 48 * 60 * 60 * 1000); // cap 48h
      const hoursPassed = deltaMsCapped / (1000 * 60 * 60);

      // --- Factores base ---
      const apetitoFactor = 0.8 + (apetitoAnsiedad / 100) * 0.8; // 0.8 .. 1.6

      // 1) Saciedad cae con el tiempo (por hora)
      // Objetivo: que con cuidado normal la revises 2-3 veces al d√≠a.
      const saciedadDecayPerHour = 7.0 * apetitoFactor * estadoDia.saciedadMod;
      saciedadReal = clamp(saciedadReal - saciedadDecayPerHour * hoursPassed, 0, 150);

      // 2) Hambre
      if (saciedadReal > 115) {
        // Si hay sobresaciedad, hambre baja MUY lento (modo A)
        const exceso = saciedadReal - 115;
        const hambreBajaPerHour = (0.6 + exceso * 0.08) * (0.95 + apetitoFactor * 0.05);
        hambre = clamp(hambre - hambreBajaPerHour * hoursPassed, 0, 100);
      } else {
        // Si no, hambre sube seg√∫n falta de saciedad
        const faltaSaciedad = clamp01(1 - saciedadVisible() / 100);
        const hambreSubePerHour = (3.5 + 10.0 * faltaSaciedad) * apetitoFactor * estadoDia.hambreMod;
        hambre = clamp(hambre + hambreSubePerHour * hoursPassed, 0, 100);
      }

      // 3) Energ√≠a (por hora)
      // Descansando recupera; si te pasas sin actividad, energ√≠a deja de ser protagonista.
      if (estadoActividad === 'Descansando') {
        const energiaRegenPerHour = 9.0 * estadoDia.energiaMod;
        energia = clamp(energia + energiaRegenPerHour * hoursPassed, 0, 100);
      } else if (estadoActividad === 'Jugando') {
        const energiaDrainPerHour = 18.0 * estadoDia.energiaMod;
        energia = clamp(energia - energiaDrainPerHour * hoursPassed, 0, 100);
      } else if (estadoActividad === 'Comiendo') {
        const energiaDrainPerHour = 3.0 * estadoDia.energiaMod;
        energia = clamp(energia - energiaDrainPerHour * hoursPassed, 0, 100);
      }

      // 4) Felicidad
      // a) decae suave por el tiempo
      const felicidadDecayPerHour = 1.2 * estadoDia.felicidadMod;
      felicidad = clamp(felicidad - felicidadDecayPerHour * hoursPassed, 0, 100);

      // b) si no haces nada por mucho tiempo, baja m√°s (aburrimiento)
      const minsSinAccion = (now - lastActionAt) / (1000 * 60);
      if (minsSinAccion > 120) { // 2 horas sin interacci√≥n
        const extra = (minsSinAccion - 120) / 60; // horas extra
        felicidad = clamp(felicidad - (1.0 * extra), 0, 100);
      }

      // c) hambriento (>=6h) afecta felicidad
      if (esHambriento(now)) {
        felicidad = clamp(felicidad - (1.8 * hoursPassed), 0, 100);
      }

      // d) si hambre muy alta, pega m√°s
      if (hambre > 75) {
        felicidad = clamp(felicidad - (2.0 * hoursPassed), 0, 100);
      }

      // 5) F√≠sico suavizado (cambia lento)
      const targetFisico = 50
        + ((saciedadVisible() - 50) * 0.35)
        - ((hambre - 50) * 0.35)
        + ((estadoActividad === 'Descansando' ? 1 : -1) * 4)
        + ((energia - 50) * 0.05);

      // En realismo: ajuste muy gradual (m√°s lento que antes)
      const fisicoAdjustRate = 0.01; // por tick (se aplica cada minuto)
      fisicoScore = clamp(fisicoScore + (targetFisico - fisicoScore) * fisicoAdjustRate, 0, 100);

      actualizarBarras();
      guardar();
    }

    // =========================
    // Persistencia (localStorage)
    // =========================

    const LS_KEY = 'mascota_v0';

    function guardar() {
      try {
        const data = {
          hambre, saciedadReal, energia, felicidad, fisicoScore,
          createdAt, lastUpdate, lastFedAt, lastActionAt,
          estadoActividad,
          apetitoAnsiedad,
          estadoDia,
          lastDayIndex
        };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      } catch (_) {
        // si falla, seguimos sin persistencia
      }
    }

    function cargar() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);

        hambre = data.hambre ?? hambre;
        saciedadReal = data.saciedadReal ?? saciedadReal;
        energia = data.energia ?? energia;
        felicidad = data.felicidad ?? felicidad;
        fisicoScore = data.fisicoScore ?? fisicoScore;

        createdAt = data.createdAt ?? Date.now();
        lastUpdate = data.lastUpdate ?? Date.now();
        lastFedAt = data.lastFedAt ?? Date.now();
        lastActionAt = data.lastActionAt ?? Date.now();

        estadoActividad = data.estadoActividad ?? estadoActividad;
        apetitoAnsiedad = data.apetitoAnsiedad ?? apetitoAnsiedad;
        estadoDia = data.estadoDia ?? estadoDia;
        lastDayIndex = data.lastDayIndex ?? 0;

        return true;
      } catch (_) {
        return false;
      }
    }

    // =========================
    // Inicializaci√≥n
    // =========================

    function crearMascotaNueva() {
      const now = Date.now();
      createdAt = now;
      lastUpdate = now;
      lastFedAt = now;
      lastActionAt = now;

      apetitoAnsiedad = Math.floor(25 + Math.random() * 70); // 25..94

      lastDayIndex = 0;
      estadoDia = pickEstadoDia(0);

      saciedadReal = 60 + Math.floor(Math.random() * 30);
      hambre = 20 + Math.floor(Math.random() * 25);
      energia = 45 + Math.floor(Math.random() * 30);
      felicidad = 45 + Math.floor(Math.random() * 30);
      fisicoScore = 45 + Math.floor(Math.random() * 20);

      estadoActividad = 'Descansando';
      guardar();
    }

    // =========================
    // Tests (mini suite)
    // =========================

    function assert(name, condition) {
      if (!condition) throw new Error('Fallo: ' + name);
      return 'OK: ' + name;
    }

    function snapshotState() {
      return {
        hambre, saciedadReal, energia, felicidad, fisicoScore,
        createdAt, lastUpdate, lastFedAt, lastActionAt,
        estadoActividad,
        apetitoAnsiedad,
        estadoDia: { ...estadoDia },
        lastDayIndex
      };
    }

    function restoreState(s) {
      hambre = s.hambre;
      saciedadReal = s.saciedadReal;
      energia = s.energia;
      felicidad = s.felicidad;
      fisicoScore = s.fisicoScore;
      createdAt = s.createdAt;
      lastUpdate = s.lastUpdate;
      lastFedAt = s.lastFedAt;
      lastActionAt = s.lastActionAt;
      estadoActividad = s.estadoActividad;
      apetitoAnsiedad = s.apetitoAnsiedad;
      estadoDia = { ...s.estadoDia };
      lastDayIndex = s.lastDayIndex;
    }

    function runTests() {
      const out = [];
      const snap = snapshotState();

      try {
        // Test 1: alimentar aumenta saciedadReal
        const s0 = saciedadReal;
        alimentar();
        out.push(assert('Alimentar sube saciedad real', saciedadReal >= s0));

        // Restaurar (alimentar cambia timestamps)
        restoreState(snap);

        // Test 2: jugar sube felicidad
        const f0 = felicidad;
        jugar();
        out.push(assert('Jugar sube felicidad', felicidad >= f0));

        restoreState(snap);

        // Test 3: hambriento si > 6h
        const now = Date.now();
        lastFedAt = now - 6.1 * 60 * 60 * 1000;
        out.push(assert('Hambriento si > 6h', esHambriento(now) === true));

        restoreState(snap);

        // Test 4: clamps
        hambre = 999; saciedadReal = -999; energia = 999; felicidad = -999; fisicoScore = 999;
        hambre = clamp(hambre, 0, 100);
        saciedadReal = clamp(saciedadReal, 0, 150);
        energia = clamp(energia, 0, 100);
        felicidad = clamp(felicidad, 0, 100);
        fisicoScore = clamp(fisicoScore, 0, 100);
        out.push(assert('Clamps rango',
          hambre <= 100 && hambre >= 0 &&
          saciedadReal <= 150 && saciedadReal >= 0 &&
          energia <= 100 && energia >= 0 &&
          felicidad <= 100 && felicidad >= 0 &&
          fisicoScore <= 100 && fisicoScore >= 0
        ));

        restoreState(snap);

        // Test 5: sobresaciedad baja hambre
        hambre = 50;
        saciedadReal = 130;
        lastUpdate = Date.now() - 60 * 1000; // simula 1 minuto
        tick();
        out.push(assert('Hambre baja con sobresaciedad (>115)', hambre < 50));

        restoreState(snap);

        // Test 6: D√≠a 0 al crear
        const base = Date.now();
        createdAt = base;
        out.push(assert('D√≠a 0 al crear', dayIndexNow(base) === 0));
        out.push(assert('D√≠a 1 tras 24h', dayIndexNow(base + 24*60*60*1000 + 1000) === 1));

      } catch (e) {
        out.push(String(e));
      } finally {
        restoreState(snap);
      }

      document.getElementById('testResults').innerText = 'Tests\n' + out.join('\n');
    }

    // =========================
    // Boot
    // =========================

    document.getElementById('btnAlimentar').onclick = alimentar;
    document.getElementById('btnJugar').onclick = jugar;

    if (!cargar()) {
      crearMascotaNueva();
    }

    // Si se carg√≥ en un estado activo, volvemos a descansar
    if (estadoActividad !== 'Descansando') estadoActividad = 'Descansando';

    // Asegurar timestamps v√°lidos
    const now = Date.now();
    createdAt = createdAt ?? now;
    lastUpdate = lastUpdate ?? now;
    lastFedAt = lastFedAt ?? now;
    lastActionAt = lastActionAt ?? now;

    // Asegurar estado del d√≠a para el d√≠a actual
    lastDayIndex = dayIndexNow(now);
    estadoDia = pickEstadoDia(lastDayIndex);

    actualizarBarras();
    runTests();

    // Realismo A: tick cada 60s
    setInterval(tick, 60 * 1000);

    // Actualizar reloj visible cada 1s (solo UI)
    setInterval(actualizarBarras, 1000);
  </script>
</body>
</html>
